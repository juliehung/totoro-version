cache:
    key: "$CI_PIPELINE_ID"
    paths:
        - node_modules
        - .gradle/wrapper
        - .gradle/caches

stages:
    - check
    - build
    - test
    - package
    - release
    - deploy

before_script:
    - export GRADLE_USER_HOME=`pwd`/.gradle
    - chmod +x gradlew

# coding style check
checkLint:
    stage: check
    only:
        refs:
            - merge_requests
        changes:
            - web/**/*
    image: node:12.16.3-stretch
    script:
        - npm install
        - npm run lint

# build stage
buildByGradle:
    stage: build
    only:
        refs:
            - merge_requests
        changes:
            - src/**/*
    image: openjdk:8-jdk-stretch
    script:
        - ./gradlew compileJava -x check --no-daemon

buildByWebpack:
    stage: build
    only:
        refs:
            - merge_requests
        changes:
            - web/**/*
    image: openjdk:8-jdk-stretch
    script:
        - apt-get install -y --no-install-recommends curl unzip
        - apt-get update && apt-get install -y --no-install-recommends --allow-unauthenticated gcc make libpng-dev
        - ./gradlew webpack -Pprod -x check -PnodeInstall --no-daemon

# test stage
testRegular:
    stage: test
    only:
        refs:
            - merge_requests
        changes:
            - src/**/*
    image: openjdk:8-jdk-stretch
    services:
        - postgres:10.4
    variables:
        POSTGRES_DB: totoro
        POSTGRES_USER: totoro
        POSTGRES_PASSWORD: totoro
    script:
        - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/totoro ./gradlew test --no-daemon
    artifacts:
        paths:
            - build/reports/tests/*
            - build/jacocoHtml/*

#testFTP:
#    stage: test
#    only:
#        refs:
#            - merge_requests
#        changes:
#            - src/**/*
#    image: openjdk:8-jdk-stretch
#    services:
#        - postgres:10.4
#    variables:
#        POSTGRES_DB: totoro
#        POSTGRES_USER: totoro
#        POSTGRES_PASSWORD: totoro
#    script:
#        - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/totoro TTR_F_U=localhost TTR_F_A=user TTR_F_S=password TTR_F_T_P=56047 TTR_F_B_P=55536 TTR_F_P=21 ./gradlew test -PtestFtp --tests io.dentall.totoro.business.service.ImageFtpBusinessServiceIntTest --no-daemon

testPackage:
    stage: package
    only:
        - master
        - release
    image: openjdk:8-jdk-stretch
    script:
        - apt-get install -y --no-install-recommends curl unzip
        - apt-get update && apt-get install -y --no-install-recommends --allow-unauthenticated gcc make libpng-dev
        - git checkout $CI_COMMIT_REF_SLUG
        - ./gradlew bootWar -Pprod -x check -PnodeInstall --no-daemon
    artifacts:
        paths:
            - build/*

# package stage
repackageByGradle:
    stage: package
    except:
        - /^(\d)+-.*$/
    image: openjdk:8-jdk-stretch
    script:
        - apt-get install -y --no-install-recommends curl unzip
        - apt-get update && apt-get install -y --no-install-recommends --allow-unauthenticated gcc make libpng-dev
        - git checkout $CI_COMMIT_TAG
        - "curl --output artifact.zip --header 'JOB-TOKEN: $CI_JOB_TOKEN' https://gitlab.com/dentall/totoro-web/-/jobs/artifacts/cicd-test/download?job=buildArtifact"
        - ls
        - unzip artifact.zip
        - ls
        - ls build
    artifacts:
        paths:
            - build/*

# release stage
releaseWarToFirebase:
    stage: release
    only:
        - tags
        - release
    dependencies:
        - repackageByGradle
    image: google/cloud-sdk:alpine
    script:
        - echo $GCP_SERVICE_KEY > ${HOME}/gcloud-service-key.json
        - gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json --project $GCP_PROJECT_ID
        - gsutil cp build/libs/* gs://dentall-admin-auto-update/

releaseWarToDevMachine:
    stage: release
    only:
        - tags
    dependencies:
        - repackageByGradle
    image: ubuntu
    before_script:
        # run ssh in job ref https://docs.gitlab.com/ee/ci/ssh_keys/#ssh-keys-when-using-the-docker-executor
        - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client curl -y )'
        - eval $(ssh-agent -s)
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh
        - echo "$DEV_MACHINE_KEY" > /home/dev.key
        - ssh-keyscan dev.dentall.site >> ~/.ssh/known_hosts
        - chmod 644 ~/.ssh/known_hosts
        - chmod 700 /home/dev.key
    script:
        - scp -i /home/dev.key ./build/libs/*.war deploy@dev.dentall.site:/home/deploy/dora-monitor/storage/wars

releaseStaticFilesToGCS:
    stage: release
    only:
        - tags
    dependencies:
        - repackageByGradle
    image: google/cloud-sdk:alpine
    script:
        - echo $GCP_SERVICE_KEY > ${HOME}/gcloud-service-key.json
        - gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json --project $GCP_PROJECT_ID
        - gsutil -m cp -r build/resources/main/public/** gs://totoro-admin-static

releaseImageToGitlabRegistry:
    stage: release
    only:
        - tags
    except:
        - /^(\d)+-.*$/
    dependencies:
        - repackageByGradle
    image: docker
    services:
        - docker:dind
    variables:
        DOCKER_DRIVER: overlay
    script:
        - apk add --update make nss git openjdk8-jre
        - war_path=build/libs/*.war
        - filename=$(basename $war_path .war)
        - version=${filename##*-}
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
        - git checkout $CI_COMMIT_TAG
        - ./gradlew -Pprod jib --image=registry.gitlab.com/dentall/totoro-admin:$CI_COMMIT_TAG -Djib.to.auth.username=gitlab-ci-token -Djib.to.auth.password=$CI_JOB_TOKEN -x processResources -x compileJava -x check --no-daemon

releaseImageToGCPRegistry:
    stage: release
    only:
        - tags
    except:
        - /^(\d)+-.*$/
    dependencies:
        - repackageByGradle
    image: docker
    services:
        - docker:dind
    variables:
        DOCKER_DRIVER: overlay
    script:
        # Write our GCP service account private key into a file
        - echo $GCP_SERVICE_KEY > ${HOME}/gcloud-service-key.json
        - docker login -u _json_key --password-stdin https://asia.gcr.io < ${HOME}/gcloud-service-key.json
        - war_path=build/libs/*.war
        - filename=$(basename $war_path .war)
        - version=${filename##*-}
        - mv build/libs/$filename.war src/main/docker/app.war
        - docker pull asia.gcr.io/$GCP_PROJECT_ID/$CI_PROJECT_NAME:cache || true
        - docker build --cache-from asia.gcr.io/$GCP_PROJECT_ID/$CI_PROJECT_NAME:cache -t asia.gcr.io/$GCP_PROJECT_ID/$CI_PROJECT_NAME:$CI_COMMIT_TAG -t asia.gcr.io/$GCP_PROJECT_ID/$CI_PROJECT_NAME:cache -f src/main/docker/Dockerfile src/main/docker
        - docker push asia.gcr.io/$GCP_PROJECT_ID/$CI_PROJECT_NAME:$CI_COMMIT_TAG
        - docker push asia.gcr.io/$GCP_PROJECT_ID/$CI_PROJECT_NAME:cache

# deploy stage
deployDevDentall8082:
    variables:
        CURL_CONTENT_TYPE: 'Content-Type: application/json'
        CURL_DATA_FOR_STOP: '{"operation": "stop", "warVersion": "dev.war"}'
        CURL_DATA_FOR_START: '{"operation": "start", "warVersion": "dev.war"}'
    only:
        - develop
    stage: deploy
    image: ubuntu
    dependencies:
        - repackageByGradle
    before_script:
        # run ssh in job ref https://docs.gitlab.com/ee/ci/ssh_keys/#ssh-keys-when-using-the-docker-executor
        - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client curl -y )'
        - eval $(ssh-agent -s)
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh
        - echo "$DEV_MACHINE_KEY" > /home/dev.key
        - ssh-keyscan dev.dentall.site >> ~/.ssh/known_hosts
        - chmod 644 ~/.ssh/known_hosts
        - chmod 700 /home/dev.key
    script:
        - scp -i /home/dev.key ./build/libs/*.war deploy@dev.dentall.site:/home/deploy/dora-monitor/storage/wars/dev.war
        - 'curl -X POST http://dev.dentall.site:8001/servers/8082/operation -H "$CURL_CONTENT_TYPE" -d "$CURL_DATA_FOR_STOP"'
        - sleep 1
        - 'curl -X POST http://dev.dentall.site:8001/servers/8082/operation -H "$CURL_CONTENT_TYPE" -d "$CURL_DATA_FOR_START"'

deployDevDentall8085:
    variables:
        CURL_CONTENT_TYPE: 'Content-Type: application/json'
        CURL_DATA_FOR_STOP: '{"operation": "stop", "warVersion": "totoro-$CI_COMMIT_TAG-$CI_COMMIT_SHORT_SHA.war"}'
        CURL_DATA_FOR_START: '{"operation": "start", "warVersion": "totoro-$CI_COMMIT_TAG-$CI_COMMIT_SHORT_SHA.war"}'
        SLACK_INFO: '{"text": "Hey everyone in <!here>, 8085 is ready with version: $CI_COMMIT_TAG"}'
    rules:
        - if: '$CI_COMMIT_TAG =~ /^staging.*/'
          when: on_success
          allow_failure: true
    stage: deploy
    image: ubuntu
    dependencies:
        - repackageByGradle
    before_script:
        # run ssh in job ref https://docs.gitlab.com/ee/ci/ssh_keys/#ssh-keys-when-using-the-docker-executor
        - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client curl -y )'
        - eval $(ssh-agent -s)
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh
        - echo "$DEV_MACHINE_KEY" > /home/dev.key
        - ssh-keyscan dev.dentall.site >> ~/.ssh/known_hosts
        - chmod 644 ~/.ssh/known_hosts
        - chmod 700 /home/dev.key
    script:
        - 'curl -X POST http://dev.dentall.site:8001/servers/8085/operation -H "$CURL_CONTENT_TYPE" -d "$CURL_DATA_FOR_STOP"'
        - sleep 1
        - 'curl -X POST http://dev.dentall.site:8001/servers/8085/operation -H "$CURL_CONTENT_TYPE" -d "$CURL_DATA_FOR_START"'
        - 'curl --location --request POST "$SLACK_INCOMING_HOOK" --header "$CURL_CONTENT_TYPE" --data-raw "$SLACK_INFO"'

deployGcpDev:
    stage: deploy
    image: google/cloud-sdk:alpine
    rules:
        - if: '$CI_COMMIT_TAG =~ /^[0-9]-[0-9]{1,2}-[0-9]{1,2}/'
          when: manual
          allow_failure: true
    script:
        - echo $GCP_SERVICE_KEY > ${HOME}/gcloud-service-key.json
        - gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json --project $GCP_PROJECT_ID
        - curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
        - curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/linux/amd64/kubectl
        - chmod +x ./kubectl
        - mv ./kubectl /usr/local/bin/kubectl
        - gcloud container clusters get-credentials his-cluster --region asia-east1
        - kubectl get pod -l run=totoro-cp -o yaml | sed 's/\(asia.gcr.io\/dentall-saas\/totoro-admin\):.*$/\1:'"$CI_COMMIT_TAG"'/' | kubectl replace -f -
