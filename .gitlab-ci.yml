cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
        - node_modules
        - .gradle/wrapper
        - .gradle/caches

stages:
    - build
    - test
    - package
    - deploy

before_script:
    - export GRADLE_USER_HOME=`pwd`/.gradle
    - chmod +x gradlew

gradle-build:
    stage: build
    image: openjdk:8-jdk-stretch
    script:
        - ./gradlew compileJava -x check -x webpackBuildDev --no-daemon

gradle-test:
    stage: test
    image: openjdk:8-jdk-stretch
    script:
        - ./gradlew test -x webpackBuildDev --no-daemon
    artifacts:
        paths:
            - build/reports/tests/*
            - build/jacocoHtml/*
# Uncomment following to expire the artifacts after defined period, https://docs.gitlab.com/ee/ci/yaml/README.html#artifacts-expire_in
#       expire_in: 90 day
gradle-front-test:
    stage: test
    image: openjdk:8-jre-stretch
    script:
        - apt-get update && apt-get install -y --no-install-recommends --allow-unauthenticated gcc make libpng-dev
        - ./gradlew npm_install npm_test -PnodeInstall --no-daemon
    artifacts:
        paths:
            - build/test-results/jest/*
            - build/test-results/lcov-report/*
#       expire_in: 90 day
gradle-repackage:
    stage: package
    image: openjdk:8-jdk-stretch
    script:
        - apt-get update && apt-get install -y --no-install-recommends --allow-unauthenticated gcc make libpng-dev
        - ./gradlew bootWar -Pdev -P4fe -x check -PnodeInstall --no-daemon
    artifacts:
        paths:
            - build/*
#       expire_in: 90 day

depolyDockerImage:
    stage: deploy
    image: docker
    services:
        - docker:dind
    dependencies:
        - gradle-repackage
    script:
        - apk --update add openjdk8-jre
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
        - ./gradlew jib --image=registry.gitlab.com/dentall/totoro-admin/$CI_COMMIT_REF_SLUG:latest -Djib.to.auth.username=gitlab-ci-token -Djib.to.auth.password=$CI_JOB_TOKEN -x processResources -x compileJava -x check --no-daemon

pages:
    stage: deploy
    image: alpine
    dependencies:
        - gradle-test
        - gradle-front-test
    script:
        - mkdir public
        - mv build/reports/tests/* public
        - mv build/jacocoHtml public
        - mv build/test-results/lcov-report public
    artifacts:
        paths:
            - public
