cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
        - node_modules
        - .gradle/wrapper
        - .gradle/caches

stages:
    - build
    - test
    - package
    - testReport

before_script:
    - export GRADLE_USER_HOME=`pwd`/.gradle
    - chmod +x gradlew

gradle-build:
    stage: build
    image: jimlin/java8-node8
    script:
        - ./gradlew compileJava -x check -PnodeInstall --no-daemon
gradle-test:
    stage: test
    image: jimlin/java8-node8
    script:
        - ./gradlew test -PnodeInstall --no-daemon
    artifacts:
        paths:
            - build/reports/tests/*
            - build/jacocoHtml/*
# Uncomment following to expire the artifacts after defined period, https://docs.gitlab.com/ee/ci/yaml/README.html#artifacts-expire_in
#       expire_in: 90 day
gradle-front-test:
    stage: test
    image: jimlin/java8-node8
    script:
        - ./gradlew npm_test -PnodeInstall --no-daemon
    artifacts:
        paths:
            - build/test-results/jest/*
            - build/test-results/lcov-report/*
#       expire_in: 90 day
gradle-repackage:
    stage: package
    image: jimlin/java8-node8
    script:
        - ./gradlew bootWar -Pdev -P4fe -x check -PnodeInstall --no-daemon
    artifacts:
        paths:
            - build/libs/*.war
#       expire_in: 90 day

pages:
    stage: testReport
    image: alpine
    dependencies:
        - gradle-test
        - gradle-front-test
    script:
        - mkdir public
        - mv build/reports/tests/* public
        - mv build/jacocoHtml public
        - mv build/test-results/lcov-report public
    artifacts:
        paths:
            - public
